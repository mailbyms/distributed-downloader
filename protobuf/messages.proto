syntax = "proto3";

package distributed_downloader;

// The main service running on the Manager node.
service ManagerService {
    // A client calls this to initiate a new download. The manager will then
    // stream the downloaded data chunks back to the client.
    rpc RequestDownload(DownloadRequest) returns (stream ClientDataChunk);

    // A server calls this to establish a persistent, bidirectional connection.
    rpc EstablishConnection(stream ServerMessage) returns (stream ManagerCommand);
}

// ============== Client-to-Manager Messages ==============

message DownloadRequest {
    string url = 1;
    string output_file = 2;
}

// Message streamed from Manager back to Client, containing file data.
message ClientDataChunk {
    oneof payload {
        // The first message sent to the client, containing metadata.
        FileMetadata metadata = 1;
        // Subsequent messages containing the actual file data.
        DataChunk chunk = 2;
    }
}

message FileMetadata {
    string job_id = 1;
    uint64 file_size = 2;
}

message DataChunk {
    string job_id = 1;
    uint64 offset = 2;
    bytes data = 3;
}


// ============== Server-to-Manager Stream Messages ==============

message ServerMessage {
    oneof payload {
        // The first message sent by a server to register itself.
        ServerRegistration register = 1;
        // A message to report that a task is complete.
        TaskResult task_result = 2;
        // A message containing the data from a downloaded chunk.
        ChunkData chunk_data = 3;
    }
}

message ServerRegistration {
    string server_id = 1;
    string address = 2;
}

// Sent from Server to Manager to report the downloaded chunk's data.
message ChunkData {
    string job_id = 1;
    string task_id = 2;
    uint64 offset = 3;
    bytes data = 4;
}

// Sent from Server to Manager to report a task's final status.
message TaskResult {
    string job_id = 1;
    string task_id = 2;
    bool success = 3;
    string error_message = 4;
}


// ============== Manager-to-Server Stream Messages ==============

message ManagerCommand {
    oneof payload {
        // A command assigning a new download task to the server.
        DownloadTask assign_task = 1;
    }
}

message DownloadTask {
    string job_id = 1;
    string task_id = 2;
    string url = 3;
    uint64 range_start = 4;
    uint64 range_end = 5;
}